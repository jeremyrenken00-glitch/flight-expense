<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FlightExpense">
    <title>FlightExpense - Pilot Expense Tracker</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000;
            color: white;
            overflow-x: hidden;
            max-width: 480px;
            margin: 0 auto;
        }
        
        .screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 50%, #0f172a 100%);
            padding-bottom: 100px;
        }
        
        .header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(90deg, #60a5fa, #22d3ee);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 14px;
            color: #93c5fd;
            margin-top: 4px;
        }
        
        .content {
            padding: 24px 16px;
        }
        
        .card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.3), rgba(6, 182, 212, 0.3));
            backdrop-filter: blur(12px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(59, 130, 246, 0.4);
            margin-bottom: 24px;
        }
        
        .btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .btn {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            color: white;
            text-align: left;
            font-size: 16px;
            font-weight: bold;
            border: none;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
        }
        
        .btn-green {
            background: linear-gradient(90deg, #059669, #047857);
            width: 100%;
            padding: 16px;
            margin-top: 24px;
        }
        
        .btn-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .link {
            color: #60a5fa;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .trip-item, .expense-item {
            background: rgba(51, 65, 85, 0.5);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            margin-bottom: 12px;
        }
        
        .flex-between {
            display: flex;
            justify-content: space-between;
        }
        
        .empty-state {
            text-align: center;
            color: #94a3b8;
            padding: 48px 16px;
        }
        
        input, select {
            width: 100%;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: white;
            font-size: 16px;
            margin-bottom: 16px;
            font-family: inherit;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        label {
            display: block;
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .back-btn {
            color: #60a5fa;
            font-size: 16px;
            margin-bottom: 24px;
            cursor: pointer;
            display: inline-block;
        }
        
        .page-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .hidden {
            display: none;
        }
        
        .icon-btn {
            background: #2563eb;
            padding: 12px;
            border-radius: 12px;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 20px;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 8px;
            font-size: 20px;
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .modal-content {
            background: #1e293b;
            border-radius: 16px;
            padding: 32px;
            border: 1px solid rgba(59, 130, 246, 0.5);
            max-width: 400px;
            margin: 16px;
        }
        
        .spinner {
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const storage = {
            get: (key) => {
                const value = localStorage.getItem(key);
                return value ? JSON.parse(value) : null;
            },
            set: (key, value) => {
                localStorage.setItem(key, JSON.stringify(value));
            }
        };

        let state = {
            screen: 'dashboard',
            trips: storage.get('trips') || [],
            expenses: storage.get('expenses') || [],
            editingReceipt: null,
            isProcessing: false,
            newTrip: {
                tripNumber: '',
                aircraft: '',
                departureDate: '',
                destination: '',
                billTo: ''
            }
        };

        function saveData() {
            storage.set('trips', state.trips);
            storage.set('expenses', state.expenses);
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            state.isProcessing = true;
            render();

            try {
                const base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: { type: 'base64', media_type: file.type, data: base64 }
                                },
                                {
                                    type: 'text',
                                    text: 'Extract receipt information and respond ONLY with JSON (no markdown): {"vendor": "name", "amount": 0.00, "date": "YYYY-MM-DD", "category": "Crew Meal or Lodging or Crew Rental Car etc"}'
                                }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const text = data.content.find(c => c.type === 'text')?.text || '{}';
                const receiptData = JSON.parse(text.replace(/```json|```/g, '').trim());

                const matchedTrip = state.trips.find(t => {
                    const tripDate = new Date(t.departureDate);
                    const receiptDate = new Date(receiptData.date);
                    const daysDiff = Math.abs((tripDate - receiptDate) / (1000 * 60 * 60 * 24));
                    return daysDiff <= 5;
                });

                state.editingReceipt = {
                    ...receiptData,
                    tripId: matchedTrip?.id || null,
                    tripNumber: matchedTrip?.tripNumber || '',
                    aircraft: matchedTrip?.aircraft || '',
                    billTo: matchedTrip?.billTo || '',
                    description: ''
                };

                state.screen = 'review';
            } catch (error) {
                alert('Error processing receipt: ' + error.message);
            } finally {
                state.isProcessing = false;
                render();
            }
        }

        function saveReceipt() {
            state.expenses.push({
                id: Date.now().toString(),
                ...state.editingReceipt,
                createdAt: new Date().toISOString()
            });
            saveData();
            state.editingReceipt = null;
            state.screen = 'dashboard';
            render();
        }

        function addTrip() {
            if (!state.newTrip.tripNumber || !state.newTrip.aircraft || !state.newTrip.departureDate) {
                alert('Please fill in required fields');
                return;
            }
            state.trips.push({
                id: Date.now().toString(),
                ...state.newTrip,
                createdAt: new Date().toISOString()
            });
            saveData();
            state.newTrip = { tripNumber: '', aircraft: '', departureDate: '', destination: '', billTo: '' };
            render();
        }

        function deleteTrip(tripId) {
            if (confirm('Delete this trip?')) {
                state.trips = state.trips.filter(t => t.id !== tripId);
                saveData();
                render();
            }
        }

        function deleteExpense(expenseId) {
            if (confirm('Delete this expense?')) {
                state.expenses = state.expenses.filter(e => e.id !== expenseId);
                saveData();
                render();
            }
        }

        function exportToCSV() {
            const headers = ['Posting Date', 'Tran Date', 'Account', 'Account Holder Last Name', 'Account Holder First Name', 'Supplier', 'Amount USD', 'Trip or Non Trip Expense?', 'Trip #', 'Aircraft Tail #', 'Bill to', 'Category', 'Description'];
            
            const rows = state.expenses.map(e => [
                e.date, e.date, 'XXXX-XXXX-XXXX-XXXX', 'Renken', 'Jeremy',
                e.vendor, e.amount, e.tripId ? 'Trip' : 'Non Trip',
                e.tripNumber || '', e.aircraft || '', e.billTo || '', e.category, e.description || ''
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses-${new Date().toISOString().slice(0, 7)}.csv`;
            a.click();
        }

        function renderDashboard() {
            const thisMonth = state.expenses.filter(e => {
                const expenseDate = new Date(e.date);
                const now = new Date();
                return expenseDate.getMonth() === now.getMonth() && expenseDate.getFullYear() === now.getFullYear();
            });
            const total = thisMonth.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);

            return `
                <div class="screen">
                    <div class="header">
                        <div class="title">FlightExpense</div>
                        <div class="subtitle">Automated Expense Tracking</div>
                    </div>
                    <div class="content">
                        <div class="stat-card">
                            <div style="font-size: 14px; color: #93c5fd; margin-bottom: 4px;">This Month</div>
                            <div style="font-size: 32px; font-weight: bold; margin-bottom: 8px;">$${total.toFixed(2)}</div>
                            <div style="font-size: 14px; color: #bfdbfe;">${thisMonth.length} expenses</div>
                        </div>
                        
                        <div class="btn-grid">
                            <label class="btn" style="cursor: pointer;">
                                <div class="btn-icon">üì∑</div>
                                <div style="font-size: 18px; font-weight: bold;">Capture</div>
                                <div style="font-size: 14px; opacity: 0.8; margin-top: 4px;">Receipt</div>
                                <input type="file" accept="image/*" capture="environment" onchange="handleFileUpload(event)">
                            </label>
                            <button class="btn btn-purple" onclick="changeScreen('trips')">
                                <div class="btn-icon">‚úàÔ∏è</div>
                                <div style="font-size: 18px; font-weight: bold;">Trips</div>
                                <div style="font-size: 14px; opacity: 0.8; margin-top: 4px;">Manage</div>
                            </button>
                        </div>

                        <div class="card">
                            <div class="section-header">
                                <div class="section-title">‚úàÔ∏è Upcoming Trips</div>
                                <a class="link" onclick="changeScreen('trips')">View All</a>
                            </div>
                            ${state.trips.slice(0, 3).map(t => `
                                <div class="trip-item">
                                    <div class="flex-between">
                                        <div>
                                            <div style="font-weight: bold; color: #93c5fd; font-size: 16px;">${t.tripNumber}</div>
                                            <div style="color: #94a3b8; font-size: 14px; margin-top: 8px;">${t.aircraft} ‚Üí ${t.destination}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="color: #94a3b8; font-size: 14px;">${t.departureDate}</div>
                                            <div style="color: #60a5fa; font-size: 12px; margin-top: 4px;">Bill: ${t.billTo}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') || '<div class="empty-state"><div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;">‚úàÔ∏è</div><p>No trips yet</p><a class="link" onclick="changeScreen(\'trips\')">Add your first trip</a></div>'}
                        </div>

                        <div class="card">
                            <div class="section-header">
                                <div class="section-title">üíµ Recent Expenses</div>
                                <a class="link" onclick="changeScreen('expenses')">View All</a>
                            </div>
                            ${state.expenses.slice(-5).reverse().map(e => `
                                <div class="expense-item">
                                    <div class="flex-between">
                                        <div style="flex: 1">
                                            <div style="font-weight: 600; font-size: 16px;">${e.vendor}</div>
                                            <div style="color: #94a3b8; font-size: 14px; margin-top: 4px;">${e.category}</div>
                                            ${e.tripNumber ? `<div style="color: #60a5fa; font-size: 12px; margin-top: 4px;">Trip ${e.tripNumber}</div>` : ''}
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: bold; color: #4ade80; font-size: 20px;">$${parseFloat(e.amount).toFixed(2)}</div>
                                            <div style="color: #94a3b8; font-size: 12px; margin-top: 4px;">${e.date}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('') || '<div class="empty-state"><div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;">üíµ</div><p>No expenses yet</p><p style="font-size: 14px; margin-top: 8px;">Capture your first receipt</p></div>'}
                        </div>

                        ${state.expenses.length > 0 ? '<button class="btn btn-green" onclick="exportToCSV()">‚¨áÔ∏è Export to Excel/CSV</button>' : ''}
                    </div>
                    ${state.isProcessing ? `
                        <div class="modal">
                            <div class="modal-content">
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div class="spinner"></div>
                                    <div>
                                        <div style="font-weight: bold;">Processing Receipt...</div>
                                        <div style="font-size: 14px; color: #94a3b8; margin-top: 4px;">AI is reading your receipt</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderReview() {
            return `
                <div class="screen">
                    <div class="content">
                        <a class="back-btn" onclick="changeScreen('dashboard')">‚Üê Cancel</a>
                        <h1 class="page-title">Review Receipt</h1>
                        <p style="color: #94a3b8; margin-bottom: 24px;">Verify and edit the extracted information</p>

                        <label>Vendor</label>
                        <input type="text" value="${state.editingReceipt.vendor || ''}" oninput="updateReceipt('vendor', this.value)">

                        <div style="display: flex; gap: 16px;">
                            <div style="flex: 1">
                                <label>Amount</label>
                                <input type="number" step="0.01" value="${state.editingReceipt.amount || ''}" oninput="updateReceipt('amount', this.value)">
                            </div>
                            <div style="flex: 1">
                                <label>Date</label>
                                <input type="date" value="${state.editingReceipt.date || ''}" oninput="updateReceipt('date', this.value)">
                            </div>
                        </div>

                        <label>Trip</label>
                        <select onchange="updateReceiptTrip(this.value)">
                            <option value="">Non-trip expense</option>
                            ${state.trips.map(t => `
                                <option value="${t.id}" ${state.editingReceipt.tripId === t.id ? 'selected' : ''}>
                                    ${t.tripNumber} - ${t.aircraft} (${t.departureDate})
                                </option>
                            `).join('')}
                        </select>

                        <label>Category</label>
                        <select onchange="updateReceipt('category', this.value)">
                            <option value="">Select category</option>
                            <option value="Crew Meal" ${state.editingReceipt.category === 'Crew Meal' ? 'selected' : ''}>Crew Meal</option>
                            <option value="Lodging" ${state.editingReceipt.category === 'Lodging' ? 'selected' : ''}>Lodging</option>
                            <option value="Crew Rental Car" ${state.editingReceipt.category === 'Crew Rental Car' ? 'selected' : ''}>Crew Rental Car</option>
                            <option value="Crew Parking" ${state.editingReceipt.category === 'Crew Parking' ? 'selected' : ''}>Crew Parking</option>
                            <option value="Crew Reposition Flight" ${state.editingReceipt.category === 'Crew Reposition Flight' ? 'selected' : ''}>Crew Reposition Flight</option>
                            <option value="TSA Pre-check renewal" ${state.editingReceipt.category === 'TSA Pre-check renewal' ? 'selected' : ''}>TSA Pre-check renewal</option>
                            <option value="Other" ${state.editingReceipt.category === 'Other' ? 'selected' : ''}>Other</option>
                        </select>

                        <label>Description (Optional)</label>
                        <input type="text" placeholder="Additional notes..." value="${state.editingReceipt.description || ''}" oninput="updateReceipt('description', this.value)">

                        <button class="btn btn-green" onclick="saveReceipt()">‚úì Save Expense</button>
                    </div>
                </div>
            `;
        }

        function renderTrips() {
            return `
                <div class="screen">
                    <div class="content">
                        <a class="back-btn" onclick="changeScreen('dashboard')">‚Üê Back</a>
                        <div class="flex-between" style="align-items: center; margin-bottom: 24px;">
                            <h1 class="page-title" style="margin: 0;">Trips</h1>
                            <button class="icon-btn" onclick="toggleAddTrip()">+</button>
                        </div>

                        <div id="add-trip-form" class="card hidden">
                            <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 16px;">Add New Trip</h2>
                            <input type="text" placeholder="Trip Number (e.g., 74F-25)" value="${state.newTrip.tripNumber}" oninput="updateNewTrip('tripNumber', this.value)">
                            <input type="text" placeholder="Aircraft (e.g., N460SJ)" value="${state.newTrip.aircraft}" oninput="updateNewTrip('aircraft', this.value)">
                            <input type="date" value="${state.newTrip.departureDate}" oninput="updateNewTrip('departureDate', this.value)">
                            <input type="text" placeholder="Destination (e.g., PDX)" value="${state.newTrip.destination}" oninput="updateNewTrip('destination', this.value)">
                            <select onchange="updateNewTrip('billTo', this.value)">
                                <option value="">Bill To...</option>
                                <option value="RED">RED</option>
                                <option value="JCD">JCD</option>
                                <option value="MTX">MTX</option>
                            </select>
                            <button class="btn btn-green" style="margin-top: 0;" onclick="addTrip()">Add Trip</button>
                        </div>

                        ${state.trips.map(t => `
                            <div class="card">
                                <div class="flex-between">
                                    <div style="flex: 1">
                                        <div style="font-size: 20px; font-weight: bold; color: #93c5fd;">${t.tripNumber}</div>
                                        <div style="color: #94a3b8; margin-top: 8px;">
                                            <div>Aircraft: ${t.aircraft}</div>
                                            <div>Destination: ${t.destination}</div>
                                            <div>Date: ${t.departureDate}</div>
                                            <div>Bill To: ${t.billTo}</div>
                                        </div>
                                    </div>
                                    <button class="delete-btn" onclick="deleteTrip('${t.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        `).join('') || '<div class="empty-state"><div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;">‚úàÔ∏è</div><p>No trips yet</p><p style="font-size: 14px; margin-top: 8px;">Add your first trip to get started</p></div>'}
                    </div>
                </div>
            `;
        }

        function renderExpenses() {
            return `
                <div class="screen">
                    <div class="content">
                        <a class="back-btn" onclick="changeScreen('dashboard')">‚Üê Back</a>
                        <h1 class="page-title">All Expenses</h1>

                        ${state.expenses.map(e => `
                            <div class="card">
                                <div class="flex-between">
                                    <div style="flex: 1">
                                        <div style="font-size: 18px; font-weight: bold;">${e.vendor}</div>
                                        <div style="color: #94a3b8; margin-top: 8px;">
                                            <div style="font-size: 14px;">${e.category}</div>
                                            ${e.tripNumber ? `<div style="font-size: 12px; color: #60a5fa; margin-top: 4px;">Trip ${e.tripNumber} ‚Ä¢ ${e.aircraft}</div>` : ''}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 20px; font-weight: bold; color: #4ade80;">$${parseFloat(e.amount).toFixed(2)}</div>
                                        <div style="font-size: 12px; color: #94a3b8; margin-top: 4px;">${e.date}</div>
                                        <button class="delete-btn" onclick="deleteExpense('${e.id}')">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        `).join('') || '<div class="empty-state"><div style="font-size: 64px; opacity: 0.3; margin-bottom: 16px;">üíµ</div><p>No expenses found</p></div>'}
                    </div>
                </div>
            `;
        }

        function changeScreen(screen) {
            state.screen = screen;
            render();
        }

        function updateReceipt(field, value) {
            state.editingReceipt[field] = value;
        }

        function updateReceiptTrip(tripId) {
            const trip = state.trips.find(t => t.id === tripId);
            if (trip) {
                state.editingReceipt.tripId = trip.id;
                state.editingReceipt.tripNumber = trip.tripNumber;
                state.editingReceipt.aircraft = trip.aircraft;
                state.editingReceipt.billTo = trip.billTo;
            } else {
                state.editingReceipt.tripId = null;
                state.editingReceipt.tripNumber = '';
                state.editingReceipt.aircraft = '';
                state.editingReceipt.billTo = '';
            }
        }

        function updateNewTrip(field, value) {
            state.newTrip[field] = value;
        }

        function toggleAddTrip() {
            const form = document.getElementById('add-trip-form');
            form.classList.toggle('hidden');
        }

        function render() {
            const app = document.getElementById('app');
            let html = '';
            
            switch(state.screen) {
                case 'dashboard':
                    html = renderDashboard();
                    break;
                case 'review':
                    html = renderReview();
                    break;
                case 'trips':
                    html = renderTrips();
                    break;
                case 'expenses':
                    html = renderExpenses();
                    break;
            }
            
            app.innerHTML = html;
        }

        render();
    </script>
</body>
</html>
